# äººäººéƒ½èƒ½è¯»æ‡‚çš„reactæºç è§£æ(å¤§å‚é«˜è–ªå¿…å¤‡)

## 5.ä»legacyæˆ–concurrentå¼€å§‹(ä»å…¥å£å¼€å§‹,ç„¶åè®©æˆ‘ä»¬å¥”å‘æœªæ¥)

### è§†é¢‘è¯¾ç¨‹&è°ƒè¯•demos

â€‹	è§†é¢‘è¯¾ç¨‹çš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€ŸæŒæ¡reactæºç è¿è¡Œçš„è¿‡ç¨‹å’Œreactä¸­çš„schedulerã€reconcilerã€rendererã€fiberç­‰ï¼Œå¹¶ä¸”è¯¦ç»†debugæºç å’Œåˆ†æï¼Œè¿‡ç¨‹æ›´æ¸…æ™°ã€‚

â€‹	è§†é¢‘è¯¾ç¨‹ï¼š

â€‹	demosï¼š

### è¯¾ç¨‹ç»“æ„:

1. <a>å¼€ç¯‡(å¬è¯´ä½ è¿˜åœ¨è‰°éš¾çš„å•ƒreactæºç )</a>
3. <a>reactå¿ƒæ™ºæ¨¡å‹(æ¥æ¥æ¥,è®©å¤§è„‘æœ‰reactæ€ç»´å§)</a>
4. <a>Fiber(æˆ‘æ˜¯åœ¨å†…å­˜ä¸­çš„dom)</a>
5. <a>ä»legacyæˆ–concurrentå¼€å§‹(ä»å…¥å£å¼€å§‹,ç„¶åè®©æˆ‘ä»¬å¥”å‘æœªæ¥)</a>
6. <a>stateæ›´æ–°æµç¨‹(setStateé‡Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆ)</a>
7. <a>renderé˜¶æ®µ(å‰å®³äº†,æˆ‘æœ‰åˆ›å»ºFiberçš„æŠ€èƒ½)</a>
8. <a>commité˜¶æ®µ(å¬è¯´rendererå¸®æˆ‘ä»¬æ‰“å¥½æ ‡è®°äº†,æ˜ å°„çœŸå®èŠ‚ç‚¹å§)</a>
9. <a>diffç®—æ³•(å¦ˆå¦ˆå†ä¹Ÿä¸æ‹…å¿ƒæˆ‘çš„diffé¢è¯•äº†)</a>
10. <a>hooksæºç (æƒ³çŸ¥é“Function Componentæ˜¯æ€æ ·ä¿å­˜çŠ¶æ€çš„å˜›)</a>
11. <a>scheduler&laneæ¨¡å‹(æ¥çœ‹çœ‹ä»»åŠ¡æ˜¯æš‚åœã€ç»§ç»­å’Œæ’é˜Ÿçš„)</a>
12. <a>concurrent mode(å¹¶å‘æ¨¡å¼æ˜¯ä»€ä¹ˆæ ·çš„)</a>
13. <a>æ‰‹å†™è¿·ä½ react(çŸ­å°ç²¾æ‚å°±æ˜¯æˆ‘)</a>



â€‹	åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­æˆ‘ä»¬å·²ç»å­¦ä¹ äº†reactçš„æ•´ä½“å·¥ä½œæµç¨‹ï¼Œå¯¹å„ä¸ªæµç¨‹åšçš„äº‹æƒ…ä¹Ÿæœ‰äº†å¤§è‡´çš„è®¤è¯†ï¼Œç°åœ¨è®©æˆ‘ä»¬ä»reactçš„å…¥å£å¼€å§‹å­¦ä¹ å„ä¸ªéƒ¨åˆ†çš„æºç å§ã€‚

### reactä¸­å…¥å£å‡½æ•°çš„æ¨¡å¼

â€‹		é¦–å…ˆï¼Œreactæœ‰3ç§æ¨¡å¼è¿›å…¥ä¸»ä½“å‡½æ•°çš„å…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ä» reactå®˜æ–¹æ–‡æ¡£ <a href="https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#feature-comparison">ä½¿ç”¨ Concurrent æ¨¡å¼ï¼ˆå®éªŒæ€§ï¼‰</a>ä¸­å¯¹æ¯”ä¸‰ç§æ¨¡å¼

- **legacy æ¨¡å¼ï¼š** `ReactDOM.render(<App />, rootNode)`ã€‚è¿™æ˜¯å½“å‰ React app ä½¿ç”¨çš„æ–¹å¼ã€‚å½“å‰æ²¡æœ‰è®¡åˆ’åˆ é™¤æœ¬æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸ªæ¨¡å¼å¯èƒ½ä¸æ”¯æŒè¿™äº›æ–°åŠŸèƒ½ã€‚
- **blocking æ¨¡å¼ï¼š** `ReactDOM.createBlockingRoot(rootNode).render(<App />)`ã€‚ç›®å‰æ­£åœ¨å®éªŒä¸­ã€‚ä½œä¸ºè¿ç§»åˆ° concurrent æ¨¡å¼çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ã€‚
- **concurrent æ¨¡å¼ï¼š** `ReactDOM.createRoot(rootNode).render(<App />)`ã€‚ç›®å‰åœ¨å®éªŒä¸­ï¼Œæœªæ¥ç¨³å®šä¹‹åï¼Œæ‰“ç®—ä½œä¸º React çš„é»˜è®¤å¼€å‘æ¨¡å¼ã€‚è¿™ä¸ªæ¨¡å¼å¼€å¯äº†*æ‰€æœ‰çš„*æ–°åŠŸèƒ½ã€‚

**ç‰¹æ€§å¯¹æ¯”ï¼š**

|                                                              | legacy æ¨¡å¼ | blocking æ¨¡å¼ | concurrent æ¨¡å¼ |
| ------------------------------------------------------------ | ----------- | ------------- | --------------- |
| [String Refs](https://zh-hans.reactjs.org/docs/refs-and-the-dom.html#legacy-api-string-refs) | âœ…           | ğŸš«**           | ğŸš«**             |
| [Legacy Context](https://zh-hans.reactjs.org/docs/legacy-context.html) | âœ…           | ğŸš«**           | ğŸš«**             |
| [findDOMNode](https://zh-hans.reactjs.org/docs/strict-mode.html#warning-about-deprecated-finddomnode-usage) | âœ…           | ğŸš«**           | ğŸš«**             |
| [Suspense](https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html#what-is-suspense-exactly) | âœ…           | âœ…             | âœ…               |
| [SuspenseList](https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#suspenselist) | ğŸš«           | âœ…             | âœ…               |
| Suspense SSR + Hydration                                     | ğŸš«           | âœ…             | âœ…               |
| Progressive Hydration                                        | ğŸš«           | âœ…             | âœ…               |
| Selective Hydration                                          | ğŸš«           | ğŸš«             | âœ…               |
| Cooperative Multitasking                                     | ğŸš«           | ğŸš«             | âœ…               |
| Automatic batching of multiple setStates                     | ğŸš«*          | âœ…             | âœ…               |
| [Priority-based Rendering](https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#splitting-high-and-low-priority-state) | ğŸš«           | ğŸš«             | âœ…               |
| [Interruptible Prerendering](https://zh-hans.reactjs.org/docs/concurrent-mode-intro.html#interruptible-rendering) | ğŸš«           | ğŸš«             | âœ…               |
| [useTransition](https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#transitions) | ğŸš«           | ğŸš«             | âœ…               |
| [useDeferredValue](https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#deferring-a-value) | ğŸš«           | ğŸš«             | âœ…               |
| [Suspense Reveal â€œTrainâ€](https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#suspense-reveal-train) | ğŸš«           | ğŸš«             | âœ…               |

*ï¼šlegacy æ¨¡å¼åœ¨åˆæˆäº‹ä»¶ä¸­æœ‰è‡ªåŠ¨æ‰¹å¤„ç†çš„åŠŸèƒ½ï¼Œä½†ä»…é™äºä¸€ä¸ªæµè§ˆå™¨ä»»åŠ¡ã€‚é React äº‹ä»¶æƒ³ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½å¿…é¡»ä½¿ç”¨ `unstable_batchedUpdates`ã€‚åœ¨ blocking æ¨¡å¼å’Œ concurrent æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„ `setState` åœ¨é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯æ‰¹å¤„ç†çš„ã€‚

**ï¼šä¼šåœ¨å¼€å‘ä¸­å‘å‡ºè­¦å‘Šã€‚

### æ¨¡å¼åœ¨reactè¿è¡Œæ—¶çš„å«ä¹‰

â€‹	legacyæ¨¡å¼æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ï¼Œå®ƒæ„å»ºdomçš„è¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥åœ¨renderçš„reconcilerä¸­ï¼Œå¦‚æœdiffçš„è¿‡ç¨‹ç‰¹åˆ«è€—æ—¶ï¼Œé‚£ä¹ˆå¯¼è‡´çš„ç»“æœå°±æ˜¯jsä¸€ç›´é˜»å¡é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡(ä¾‹å¦‚ç”¨æˆ·çš„ç‚¹å‡»äº‹ä»¶)ï¼Œè¡¨ç°ä¸ºé¡µé¢çš„å¡é¡¿ï¼Œæ— æ³•å“åº”ã€‚

â€‹	concurrent Modeæ˜¯reactæœªæ¥çš„æ¨¡å¼ï¼Œå®ƒç”¨æ—¶é—´ç‰‡è°ƒåº¦å®ç°äº†å¼‚æ­¥å¯ä¸­æ–­çš„ä»»åŠ¡ï¼Œæ ¹æ®è®¾å¤‡æ€§èƒ½çš„ä¸åŒï¼Œæ—¶é—´ç‰‡çš„é•¿åº¦ä¹Ÿä¸ä¸€æ ·ï¼Œåœ¨æ¯ä¸ªæ—¶é—´ç‰‡ä¸­ï¼Œå¦‚æœä»»åŠ¡åˆ°äº†è¿‡æœŸæ—¶é—´ï¼Œå°±ä¼šä¸»åŠ¨è®©å‡ºçº¿ç¨‹ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚è¿™éƒ¨åˆ†å°†åœ¨ç¬¬11èŠ‚ scheduler&laneæ¨¡å‹ è¿™ç« ä¼šå…·ä½“è®²è§£reactæ˜¯å¦‚ä½•å®ç°å¼‚æ­¥å¯ä¸­æ–­çš„ä»»åŠ¡ï¼Œä»¥åŠä»»åŠ¡çš„ä¼˜å…ˆçº§å’Œé«˜ä¼˜å…ˆçº§æ˜¯å¦‚æœæ’é˜Ÿçš„ã€‚

### 	å‡½æ•°è°ƒç”¨çš„é¡ºåºå’Œä½œç”¨

1. ä¸»è¦æµç¨‹ï¼š

   ![_3](/Users/allenchen/Desktop/æ–‡ç« /äººäººéƒ½èƒ½è¯»æ‡‚çš„reactæºç è§£æ(å¤§å‚é«˜è–ªå¿…å¤‡)/_3.png)

   

2. ä¸»è¦å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ï¼š
 - çœ‹æ–­ç‚¹è°ƒè¯•è§†é¢‘ï¼Œå‡½æ•°è°ƒç”¨ç»†èŠ‚æ›´æ¸…æ¥šï¼š

 - ç”¨demo_0æ¥çœ‹çœ‹æ‰§è¡Œè¿‡ç¨‹ï¼š

   ![_2](/Users/allenchen/Desktop/æ–‡ç« /äººäººéƒ½èƒ½è¯»æ‡‚çš„reactæºç è§£æ(å¤§å‚é«˜è–ªå¿…å¤‡)/_2.png)

   **legacyæ¨¡å¼ï¼š**

   - renderè°ƒç”¨legacyRenderSubtreeIntoContainerï¼Œæœ€åcreateRootImplä¼šè°ƒç”¨åˆ°createFiberRootåˆ›å»ºfiberRootNode,ç„¶åè°ƒç”¨createHostRootFiberåˆ›å»ºrootFiberï¼Œå…¶ä¸­fiberRootNodeæ˜¯æ•´ä¸ªé¡¹ç›®çš„çš„æ ¹èŠ‚ç‚¹ï¼ŒrootFiberæ˜¯å½“å‰åº”ç”¨æŒ‚åœ¨çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ReactDOM.renderè°ƒç”¨åçš„æ ¹èŠ‚ç‚¹
    ```jsx
   //æœ€ä¸Šå±‚çš„èŠ‚ç‚¹æ˜¯æ•´ä¸ªé¡¹ç›®çš„æ ¹èŠ‚ç‚¹fiberRootNode
   ReactDOM.render(<App />, document.getElementById("root"));//rootFiber
   ReactDOM.render(<App />, document.getElementById("root"));//rootFiber
    ```
   â€‹	![_4](/Users/allenchen/Desktop/æ–‡ç« /äººäººéƒ½èƒ½è¯»æ‡‚çš„reactæºç è§£æ(å¤§å‚é«˜è–ªå¿…å¤‡)/_4.png)

   - åˆ›å»ºå®ŒFiberèŠ‚ç‚¹åï¼ŒlegacyRenderSubtreeIntoContainerè°ƒç”¨updateContaineråˆ›å»ºåˆ›å»ºUpdateå¯¹è±¡æŒ‚è½½åˆ°updateQueueçš„ç¯å½¢é“¾è¡¨ä¸Šï¼Œç„¶åæ‰§è¡ŒscheduleUpdateOnFiberè°ƒç”¨performSyncWorkOnRootè¿›å…¥renderé˜¶æ®µå’Œcommité˜¶æ®µ

   

   **concurrentæ¨¡å¼ï¼š**

   - createRootè°ƒç”¨createRootImplåˆ›å»ºfiberRootNodeå’ŒrootNode
   - åˆ›å»ºå®ŒFiberèŠ‚ç‚¹åï¼Œè°ƒç”¨ReactDOMRoot.prototype.renderæ‰§è¡ŒupdateContainerï¼Œç„¶åscheduleUpdateOnFiberå¼‚æ­¥è°ƒåº¦performConcurrentWorkOnRootè¿›å…¥renderé˜¶æ®µå’Œcommité˜¶æ®µ

   â€‹	


3. legacyæ¨¡å¼ä¸»è¦å‡½æ•°æ³¨é‡Šï¼š
```js
function legacyRenderSubtreeIntoContainer(parentComponent, children, container, forceHydrate, callback) {
  //...
  var root = container._reactRootContainer;
  var fiberRoot;

  if (!root) {
    // mountæ—¶
    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(container, forceHydrate);//åˆ›å»ºrootèŠ‚ç‚¹
    fiberRoot = root._internalRoot;

    if (typeof callback === 'function') {//å¤„ç†å›è°ƒ
      var originalCallback = callback;

      callback = function () {
        var instance = getPublicRootInstance(fiberRoot);
        originalCallback.call(instance);
      };
    } 


    unbatchedUpdates(function () {
      updateContainer(children, fiberRoot, parentComponent, callback);//åˆ›å»ºupdateå…¥å£
    });
  } else {
    // updateæ—¶
    fiberRoot = root._internalRoot;

    if (typeof callback === 'function') {//å¤„ç†å›è°ƒ
      var _originalCallback = callback;

      callback = function () {
        var instance = getPublicRootInstance(fiberRoot);

        _originalCallback.call(instance);
      };
    } 
    
    updateContainer(children, fiberRoot, parentComponent, callback);
  }
}
```

```js
function createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks) {
  var root = new FiberRootNode(containerInfo, tag, hydrate);//åˆ›å»ºfiberRootNode
  const uninitializedFiber = createHostRootFiber(tag);//åˆ›å»ºrootFiber
  //rootFiberå’ŒfiberRootNodeè¿æ¥
  root.current = uninitializedFiber;
  uninitializedFiber.stateNode = root;
  //åˆ›å»ºupdateQueue
  initializeUpdateQueue(uninitializedFiber);
  return root;
}

//å¯¹äºHostRootæˆ–è€…ClassComponentä¼šä½¿ç”¨initializeUpdateQueueåˆ›å»ºupdateQueueï¼Œç„¶åå°†updateQueueæŒ‚è½½åˆ°fiberèŠ‚ç‚¹ä¸Š
export function initializeUpdateQueue<State>(fiber: Fiber): void {
  const queue: UpdateQueue<State> = {
    baseState: fiber.memoizedState,//åˆå§‹stateï¼Œåé¢ä¼šåŸºäºè¿™ä¸ªstateï¼Œæ ¹æ®Updateè®¡ç®—æ–°çš„state
    firstBaseUpdate: null,//Updateå½¢æˆçš„é“¾è¡¨çš„å¤´
    lastBaseUpdate: null,//Updateå½¢æˆçš„é“¾è¡¨çš„å°¾
		//æ–°äº§ç”Ÿçš„updateä¼šä»¥å•å‘ç¯çŠ¶é“¾è¡¨ä¿å­˜åœ¨shared.pendingä¸Šï¼Œè®¡ç®—stateçš„æ—¶å€™ä¼šå‰ªå¼€è¿™ä¸ªç¯çŠ¶é“¾è¡¨ï¼Œå¹¶ä¸”è¿æ¥åœ¨			  //lastBaseUpdateå
    shared: {
      pending: null,
    },
    effects: null,
  };
  fiber.updateQueue = queue;
}
```

```js
function updateContainer(element, container, parentComponent, callback) {
  var lane = requestUpdateLane(current$1);//è·å–å½“å‰å¯ç”¨lane åœ¨12ç« è®²è§£
  var update = createUpdate(eventTime, lane); //åˆ›å»ºupdate

  update.payload = {
    element: element//jsx
  };

  enqueueUpdate(current$1, update);//updateå…¥é˜Ÿ
  scheduleUpdateOnFiber(current$1, lane, eventTime);//è°ƒåº¦update
  return lane;
}
```

```js
function scheduleUpdateOnFiber(fiber, lane, eventTime) {
  if (lane === SyncLane) {//åŒæ­¥lane å¯¹åº”legacyæ¨¡å¼
    //...
    performSyncWorkOnRoot(root);//renderé˜¶æ®µçš„èµ·ç‚¹ renderåœ¨åœ°6ç« è®²è§£
  } else {//concurrentæ¨¡å¼
    //...
    ensureRootIsScheduled(root, eventTime);//ç¡®ä¿rootè¢«è°ƒåº¦
  } 
}
```
4. concurrentä¸»è¦å‡½æ•°æ³¨é‡Šï¼š
```js
function ensureRootIsScheduled(root, currentTime) {
  //...
  var nextLanes = getNextLanes(root, root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes); //è®¡ç®—nextLanes

  //...

 //å°†laneçš„ä¼˜å…ˆçº§è½¬æ¢æˆschdulerçš„ä¼˜å…ˆçº§
  var schedulerPriorityLevel = lanePriorityToSchedulerPriority(newCallbackPriority);
  //ä»¥schedulerPriorityLevelçš„ä¼˜å…ˆçº§æ‰§è¡ŒperformConcurrentWorkOnRoot ä¹Ÿå°±æ˜¯concurrentæ¨¡å¼çš„èµ·ç‚¹
  newCallbackNode = 	  scheduleCallback(schedulerPriorityLevel,performConcurrentWorkOnRoot.bind(null, root));
}
```
5. ä¸¤ç§æ¨¡å¼çš„ä¸åŒç‚¹ï¼š
   1. createRootImplä¸­ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ä¸€æ · ä¸€ä¸ªæ˜¯LegacyRootä¸€ä¸ªæ˜¯ConcurrentRoot
   2. requestUpdateLaneä¸­è·å–çš„laneçš„ä¼˜å…ˆçº§ä¸åŒ
   3. åœ¨å‡½æ•°scheduleUpdateOnFiberä¸­æ ¹æ®ä¸åŒä¼˜å…ˆçº§è¿›å…¥ä¸åŒåˆ†æ”¯ï¼Œlegacyæ¨¡å¼è¿›å…¥performSyncWorkOnRootï¼Œconcurrentæ¨¡å¼ä¼šå¼‚æ­¥è°ƒåº¦performConcurrentWorkOnRoot




